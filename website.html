<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Emoji Face Detector</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <style>
        /* CSS SAMA SEPERTI SEBELUMNYA (MODERN DARK THEME) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background-color: #121212;
            color: white;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
        }
        h1 {
            font-weight: 300; font-size: 1.2rem; letter-spacing: 2px;
            margin-bottom: 20px; text-transform: uppercase; color: #a0a0a0;
        }
        .camera-container {
            position: relative; width: 100%; max-width: 640px;
            aspect-ratio: 4/3; background: #000; border-radius: 16px;
            overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        .input_video, .output_canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scaleX(-1); /* Mirror effect */
        }
        .loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00bcd4; font-size: 0.9rem; z-index: 10; display: flex;
            flex-direction: column; align-items: center; gap: 10px;
        }
        .spinner {
            width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #00bcd4; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .footer { margin-top: 20px; font-size: 0.7rem; color: #444; }
    </style>
</head>
<body>

    <h1>Smile Detector üòÅ</h1>

    <div class="camera-container">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <span>Memuat Model AI...</span>
        </div>
        <video class="input_video" playsinline muted></video>
        <canvas class="output_canvas"></canvas>
    </div>

    <div class="footer">Ayo tersenyum ke kamera!</div>

    <script>
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const canvasCtx = canvasElement.getContext('2d');
        const loadingScreen = document.getElementById('loading');

        // Fungsi pembantu untuk menghitung jarak 3D antara dua titik landmark
        function calculateDistance(point1, point2) {
            const dx = point1.x - point2.x;
            const dy = point1.y - point2.y;
            const dz = point1.z - point2.z; // Menggunakan kedalaman (Z) agar lebih akurat
            return Math.sqrt(dx * dx + dy * dy + dz * dz);
        }

        function onResults(results) {
            if(results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                loadingScreen.style.display = 'none';
            }

            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            // Gambar video asli sebagai background
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiFaceLandmarks) {
                for (const landmarks of results.multiFaceLandmarks) {
                    // --- LOGIKA DETEKSI SENYUM ---
                    
                    // Titik sudut mulut: 61 (kiri), 291 (kanan)
                    const mouthCornerLeft = landmarks[61];
                    const mouthCornerRight = landmarks[291];
                    const mouthWidth = calculateDistance(mouthCornerLeft, mouthCornerRight);

                    // Titik sudut mata luar (untuk referensi skala wajah): 33 (kiri), 263 (kanan)
                    const eyeOuterLeft = landmarks[33];
                    const eyeOuterRight = landmarks[263];
                    const faceScaleReference = calculateDistance(eyeOuterLeft, eyeOuterRight);

                    // Hitung rasio lebar mulut terhadap skala wajah.
                    // Ini penting agar deteksi tetap akurat walau wajah jauh/dekat dari kamera.
                    const smileRatio = mouthWidth / faceScaleReference;

                    // Ambang batas (Threshold) untuk dianggap senyum.
                    // Nilai ini didapat dari eksperimen. Jika > 0.55 dianggap tersenyum.
                    const SMILE_THRESHOLD = 0.55; 

                    let currentEmoji = "üòê"; // Emoji default (netral)
                    if (smileRatio > SMILE_THRESHOLD) {
                        currentEmoji = "üòÅ"; // Emoji senyum
                    }

                    // --- RENDER EMOJI ---

                    // Gunakan ujung hidung (landmark 1) sebagai titik tengah emoji
                    const noseTip = landmarks[1];
                    const x = noseTip.x * canvasElement.width;
                    const y = noseTip.y * canvasElement.height;

                    // Atur font agar dinamis mengikuti ukuran wajah di layar
                    // Semakin dekat wajah, semakin besar emojinya.
                    const fontSize = Math.floor(faceScaleReference * canvasElement.width * 1.8); 

                    canvasCtx.textAlign = "center";
                    canvasCtx.textBaseline = "middle";
                    // Menggunakan font standar sistem yang mendukung emoji
                    canvasCtx.font = `${fontSize}px 'Segoe UI Emoji', 'Roboto', sans-serif`;
                    
                    // Gambar emoji di canvas
                    canvasCtx.fillText(currentEmoji, x, y);
                }
            }
            canvasCtx.restore();
        }

        const faceMesh = new FaceMesh({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
        }});

        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true, // Penting untuk akurasi bibir
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        faceMesh.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await faceMesh.send({image: videoElement});
            },
            width: 1280,
            height: 720,
            facingMode: "user"
        });
        
        camera.start();
    </script>
</body>
</html>
